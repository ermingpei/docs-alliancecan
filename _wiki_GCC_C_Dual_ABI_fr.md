# GCC C++ Dual ABI

This page is a translated version of the page GCC C++ Dual ABI and the translation is 100% complete.

Other languages: [English](link-to-english-page), [français](current-page-url)

A significant change was introduced to the application binary interface (ABI) between GCC versions 4.9 and 5.1.  No problems arise if all source code, including dependent libraries, is compiled with the same compiler version. However, using different versions can prevent linking from working correctly due to this change, especially when linking against pre-compiled libraries provided by external vendors. In such a case, use the Dual ABI feature to ensure that linking is done appropriately with the old ABI [1]. For example, you should pass `-D_GLIBCXX_USE_CXX11_ABI=0` to GCC if you are using a version greater than 5.1.

In some cases, `-D_GLIBCXX_USE_CXX11_ABI=0` resolves errors like `.../extensions.hpp(38): error: “std::list” is ambiguous`. The class is not necessarily `std::list`.


## Application Binary Interface (ABI)

By default, compilers each use a specific algorithm to compose unique names and export `extern "C++"` symbol names. These symbol names are part of the ABI used to link compiled code with libraries. If multiple vendors try to always use the same ABI on a platform (e.g., Linux), occasional modifications are necessary.  Therefore, any change to a compiler's ABI can prevent linking.


## Example

This example demonstrates the effect of options passed to GCC (>=v5.1) on the ABI used by the generated binaries. For linking to work correctly for the program or library, all symbol names must match; otherwise, linking will fail. Here, the symbol names generated by the compiler differ depending on the compiler configuration.


### Source Code

The following C++ program will be compiled to generate the ABI symbol names it contains.

**File: main.cxx**

```c++
#include <iostream>
#include <string>

int main() {
  using namespace std;
  string mystring = "Hello World!";
  cout << mystring << endl;
}
```

This program will be compiled with several different parameters to show the difference in ABI calls, as follows:


### Makefile

**File: Makefile**

```makefile
all: \
	main-cxx98.o \
	main-cxx98-newabi.o \
	main-cxx98-oldabi.o \
	main-cxx11.o \
	main-cxx11-newabi.o \
	main-cxx11-oldabi.o \
	diff-cxx98 \
	diff-cxx11 \
	diff-cxx-default \
	clean

clean:
	rm -f *.o *.ii *.s
	rm -f *.symbols

main-cxx98.o: main.cxx
	$(CXX) -c -o $@ -std=c++98 $<
	nm $@ | cut -c 20- > $@.symbols

main-cxx98-newabi.o: main.cxx
	$(CXX) -c -o $@ -std=c++98 -D_GLIBCXX_USE_CXX11_ABI=1 $<
	nm $@ | cut -c 20- > $@.symbols

main-cxx98-oldabi.o: main.cxx
	$(CXX) -c -o $@ -std=c++98 -D_GLIBCXX_USE_CXX11_ABI=0 $<
	nm $@ | cut -c 20- > $@.symbols

main-cxx11.o: main.cxx
	$(CXX) -c -o $@ -std=c++11 $<
	nm $@ | cut -c 20- > $@.symbols

main-cxx11-newabi.o: main.cxx
	$(CXX) -c -o $@ -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=1 $<
	nm $@ | cut -c 20- > $@.symbols

main-cxx11-oldabi.o: main.cxx
	$(CXX) -c -o $@ -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=0 $<
	nm $@ | cut -c 20- > $@.symbols

diff-cxx98: main-cxx98-newabi.o main-cxx98-oldabi.o
	@echo "=============================================================================="
	@echo "Difference between the old and new C++ ABIs with -std=c++98..."
	diff --suppress-common-lines main-cxx98-oldabi.o.symbols main-cxx98-newabi.o.symbols || true

diff-cxx11: main-cxx11-newabi.o main-cxx11-oldabi.o
	@echo "=============================================================================="
	@echo "Difference between the old and new C++ ABIs with -std=c++11..."
	diff --suppress-common-lines main-cxx11-oldabi.o.symbols main-cxx11-newabi.o.symbols || true

diff-cxx-default: main-cxx98.o main-cxx11.o
	@echo "=============================================================================="
	@echo "Difference between -std=c++98 and -std=c++11 ABI w/o _GLIBCXX_USE_CXX11_ABI..."
	diff --suppress-common-lines main-cxx98.o.symbols main-cxx11.o.symbols || true
```

**NOTE:** Before running `make`, ensure you have loaded a GCC 5.1 or later module.


### Running the Example

Here is the result of running `make` on the same Makefile, with different compilation options.

**File: Makefile Output**

```
$ make
c++ -c -o main-cxx98.o -std=c++98  main.cxx
nm main-cxx98.o | cut -c 20- >main-cxx98.o.symbols
c++ -c -o main-cxx98-newabi.o -std=c++98 -D_GLIBCXX_USE_CXX11_ABI=1  main.cxx
nm main-cxx98-newabi.o | cut -c 20- >main-cxx98-newabi.o.symbols
c++ -c -o main-cxx98-oldabi.o -std=c++98 -D_GLIBCXX_USE_CXX11_ABI=0  main.cxx
nm main-cxx98-oldabi.o | cut -c 20- >main-cxx98-oldabi.o.symbols
c++ -c -o main-cxx11.o -std=c++11  main.cxx
nm main-cxx11.o | cut -c 20- >main-cxx11.o.symbols
c++ -c -o main-cxx11-newabi.o -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=1  main.cxx
nm main-cxx11-newabi.o | cut -c 20- >main-cxx11-newabi.o.symbols
c++ -c -o main-cxx11-oldabi.o -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=0  main.cxx
nm main-cxx11-oldabi.o | cut -c 20- >main-cxx11-oldabi.o.symbols
==============================================================================
Difference between the old and new C++ ABIs with -std=c++98...
diff --suppress-common-lines main-cxx98-oldabi.o.symbols main-cxx98-newabi.o.symbols || true
7,8c7,8
< _ZNSsC1EPKcRKSaIcE
< _ZNSsD1Ev
---
> _ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1EPKcRKS3_
> _ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEED1Ev
14c14
< _ZStlsIcSt11char_traitsIcESaIcEERSt13basic_ostreamIT_T0_ES7_RKSbIS4_S5_T1_E
---
> _ZStlsIcSt11char_traitsIcESaIcEERSt13basic_ostreamIT_T0_ES7_RKNSt7__cxx1112basic_stringIS4_S5_T1_EE
==============================================================================
Difference between the old and new C++ ABIs with -std=c++11...
diff --suppress-common-lines main-cxx11-oldabi.o.symbols main-cxx11-newabi.o.symbols || true
7,8c7,8
< _ZNSsC1EPKcRKSaIcE
< _ZNSsD1Ev
---
> _ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1EPKcRKS3_
> _ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEED1Ev
15c15
< _ZStlsIcSt11char_traitsIcESaIcEERSt13basic_ostreamIT_T0_ES7_RKSbIS4_S5_T1_E
---
> _ZStlsIcSt11char_traitsIcESaIcEERSt13basic_ostreamIT_T0_ES7_RKNSt7__cxx1112basic_stringIS4_S5_T1_EE
==============================================================================
Difference between -std=c++98 and -std=c++11 ABI w/o _GLIBCXX_USE_CXX11_ABI...
diff --suppress-common-lines main-cxx98.o.symbols main-cxx11.o.symbols || true
12a13
> _ZStL19piecewise_construct
$
```

That is, in the last case, using only `-std=c++98` or `-std=c++11`, the ABI does not differ; the compiler will use the default (latest) ABI; in the two previous cases, `_GLIBCXX_USE_CXX11_ABI` has the value 0 (old ABI) or 1 (new ABI) with `-std=c++98` or `-std=c++11`; this ensures that the old or new ABI is used.  Thus, to link with binaries compiled with an older ABI, you must specify `_GLIBCXX_USE_CXX11_ABI=0` to compile C++ code.


## References

[1] Free Software Foundation. The GNU C++ Library, Chapter 3. [https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html](https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html)


**(Retrieved from "https://docs.alliancecan.ca/mediawiki/index.php?title=GCC_C%2B%2B_Dual_ABI/fr&oldid=43717")**
