# JupyterHub

JupyterHub is the best system for allowing multiple people to simultaneously use Jupyter Notebook, whether it's a group in a teaching or research context, or in a data science company.<sup>[1]</sup> JupyterHub offers a pre-configured version of JupyterLab and/or Jupyter Notebook; for more information on configuration options, see the [Jupyter page](link-to-jupyter-page).


## Running Notebooks

Jupyter Lab and notebooks are suitable for your short interactive tasks for quick testing, debugging, or data visualization (a few minutes). For longer analyses, you must use a non-interactive task with `sbatch`.

See also Running notebooks as Python scripts below.


## Contents

1. Alliance Initiatives
    * JupyterHub on a Cluster
    * JupyterHub for Universities and Schools
2. Server Options
    * Computing Resources
    * User Interface
3. JupyterLab
    * JupyterLab Interface
        * Menu Bar (at the top)
        * Selection Tool (on the left)
        * Application Area (on the right)
        * Status Bar (at the bottom)
    * Pre-built Applications
        * Command Line Interpreters
            * Julia Console
            * Python Console
            * Terminal
        * Available Notebook Kernels
            * Julia Notebook
            * Python Notebook
        * Other Applications
            * OpenRefine
            * RStudio
            * VS Code
            * Desktop
4. Running Notebooks as Python Scripts
5. Error Messages
6. References


## Alliance Initiatives

Our network includes several hubs that provide access to cutting-edge computing resources.


### JupyterHub on a Cluster

Use your Alliance account username and password to connect to the following clusters: ‡

* **Béluga:** Provides access to JupyterLab servers generated by interactive tasks launched directly from the web interface.
* **Cedar:** Provides access to JupyterLab servers generated by interactive tasks launched directly from the web interface. Authentication is done via `idpmfa.mit.c3.ca`.
* **Narval:** Provides access to JupyterLab servers generated by interactive tasks launched directly from the web interface.
* **Niagara:** Provides access to JupyterLab, one of the applications of SciNet's Open OnDemand portal. For more information, see the [wiki page](link-to-wiki-page).
* **Graham:** Provides access to JupyterLab servers generated by interactive tasks launched directly from the web interface.

‡ The compute nodes on which Jupyter kernels are enabled do not have internet access.  Consequently, you can only copy files to and from your own computer. You cannot download code or data from the internet, for example with `git clone` or `pip install` if the wheel is not in our wheelhouse. Also, problems could arise if your code performs downloads or uploads, for example in machine learning where data is often downloaded from the code.


### JupyterHub for Universities and Schools

In collaboration with the Alliance and Cybera, the Pacific Institute for the Mathematical Sciences offers cloud hubs to educational institutions. Each can have its own hub that users access via their institution account. The hubs are hosted by our [cloud service](link-to-cloud-service) and are primarily used for training purposes. Institutions wishing to obtain a hub can consult [Syzygy](link-to-syzygy).


## Server Options

### Server Options on Béluga

Once connected and depending on the JupyterHub configuration, the web browser is redirected to:

a) a previously launched Jupyter server,
b) a new Jupyter server with default options, or
c) a form to configure the Jupyter server options before pressing the Start button.

In all cases, this is equivalent to accessing the requested resources via an interactive task on the corresponding cluster.

**Important:** On each cluster, only one interactive task at a time gets higher priority to start within a few seconds or minutes. This includes tasks run via `salloc`, `srun`, and JupyterHub tasks. If you have another interactive task running on the cluster where JupyterHub is located, your new Jupyter session may not start before the 5-minute limit.


### Computing Resources

For example, the options for JupyterHub on Béluga are:

* **Account:** You can use a compute account of type `def-*`, `rrg-*`, `rpp-*`, or `ctb-*` to which you have access;
* **Time (hours):** Number of hours required for the session;
* **Number of cores:** Number of CPUs reserved on a single node;
* **Memory (MB):** Total RAM limit for the entire session;
* **GPU configuration** (optional): At least one GPU;
* **User Interface** (see below).


### User Interface

JupyterHub allows access to one server at a time, but several interfaces can be offered under User Interface:

* **Jupyter Notebook (classic interface):** This interface offers many features, but most users now choose JupyterLab, which is a better platform and has many more features;
* **JupyterLab (modern interface):** This Jupyter interface is the most recommended for interactive prototyping and data visualization;
* **Terminal (for a single terminal):** This interface provides access to a terminal connected to a remote account, which is comparable to connecting to a server via SSH.

Note: JupiterHub can also be configured to display a specific interface, for example in the case of a special event.


## JupyterLab

JupyterLab is the generally recommended user interface for a session via JupyterHub. Your remote files and directories can be managed directly from JupyterLab, and you can launch Jupyter applications such as a terminal, notebooks (Python 3), RStudio, and a Linux desktop. You can add your own kernels, which will be displayed as applications. To configure these kernels, refer to [Adding Kernels](link-to-adding-kernels).


### JupyterLab Interface

When JupyterLab is ready to be used, the interface includes several panels.

**Default tab when JupyterLab is loaded**

* **Menu Bar (at the top)**
    * **File**
        * **Hub Control Panel:** To manually stop the JupyterLab server and the corresponding task on the cluster. This is useful when you want to start a new JupyterLab server with more or less resources;
        * **Log Out:** The JupyterHub session ends, which also stops the JupyterLab server and the corresponding task on the cluster.
    Most other menu options are for Jupyter notebooks and applications.

* **Selection Tool (on the left)**
    * **File Browser** (folder icon): To view the contents of your `/home`, `/project`, and `/scratch` spaces; it is possible to upload files there;
    * **Running Terminals and Kernels** (stop icon): To stop kernel and terminal sessions;
    * **Commands**
    * **Property Inspector**
    * **Open Tabs:** To move between application tabs; to close application tabs; the corresponding kernels remain active;
    * **Loaded and available modules**
    * **Software** (blue diamond icon): Our modules can be loaded and unloaded in the JupyterLab session. Depending on the loaded modules, different Jupyter application icons will be displayed under the Launcher tab. The search field can be used to find an available module and display the result in the Available Modules sub-panel. Note that some modules remain hidden until their dependencies are loaded; we recommend searching for a particular module with the command `module spider module name` from a terminal. The Loaded Modules sub-panel displays the list of modules loaded in the entire JupyterLab session. Note that while the `python` and `ipython-kernel` modules are loaded by default, other modules must be loaded before certain applications or notebooks can be launched, for example `scipy-stack`. The last sub-panel, Available Modules, displays the list of available modules, which is similar to the result of the `module avail` command. Click on a module name to display the module details. Click on the Load link to load the module and add it to the list of loaded modules.

* **Application Area (on the right)**
    The Launcher tab opens by default. It shows all available Jupyter notebooks and applications, depending on the modules that are loaded.

* **Status Bar (at the bottom)**
    Click on the icons to go to the Running Terminals and Kernels tool.


### Pre-built Applications

JupyterLab provides access to a terminal, an IDE (desktop), a Python console, and several options for creating plain text and formatted (markdown) files. We only present here the main applications that are compatible with our software stack.


#### Command Line Interpreters

[Button to launch the Julia console]
[Button to launch the Python console]
[Button to launch the terminal]

* **Julia Console:** To allow the launch of the Julia 1.x console, you must first load an `ijulia-kernel` module. When the console is launched, the Julia interpreter is presented in a new JupyterLab tab.
* **Python Console:** Access to Python 3.x is available by default in a new JupyterLab session. When the console is launched, a Python 3 interpreter is displayed in a new JupyterLab tab.
* **Terminal:** This opens a terminal in a new JupyterLab tab:
    * The terminal opens an interpreter (Bash) on the remote compute node, without needing an SSH connection.
    * Provides access to remote file systems (`/home`, `/project`, `/scratch`)
    * Allows running compute tasks
    The terminal allows text to be copied and pasted:
    * To copy, select the text and press Ctrl+C
    Note: usually, Ctrl+C is used to send a SIGINT signal to a running process or to cancel the current command. To do this in a JupyterLab terminal, click on the terminal to deselect text before pressing Ctrl+C
    * To paste, press Ctrl+V


#### Available Notebook Kernels

* **Julia Notebook:** To allow the launch of Julia 1.x notebooks, you must load an `ijulia-kernel` module. Once launched, the Julia notebook is presented in a new JupyterLab tab.
* **Python Notebook:**

**Searching for scipy-stack modules**

Before opening a notebook that requires one of the following scientific packages, you must load the `scipy-stack` module from the JupyterLab Software tool:

`ipython`, `ipython_genutils`, `ipykernel`, `ipyparallel`, `matplotlib`, `numpy`, `pandas`, `scipy`

Other packages to highlight: `Cycler`, `futures`, `jupyter_client`, `jupyter_core`, `mpmath`, `pathlib2`, `pexpect`, `pickleshare`, `ptyprocess`, `pyzmq`, `simplegeneric`, `sympy`, `tornado`, `traitlets`, and many others; click on the `scipy-stack` module to display all extensions.

Note: you can also install the packages you need with, for example, the command `!pip install --no-index numpy` inside a cell. For some packages (e.g., `plotly`), you may need to restart the notebook kernel before importing the package.

Installing packages in the default Python kernel environment is temporary, for the duration of the JupyterLab session; you will need to reinstall these packages in the next JupyterLab session. To create a persistent Python environment, you must configure a custom Python kernel.

To open an existing Python notebook:

1. Return to File Browser.
2. Locate the *.ipynb file.
3. Double-click on the *.ipynb file.

The Python notebook opens in a new JupyterLab tab. A new IPython kernel will start in the background for the notebook.

To open a Python notebook in the current directory of the File Browser:

1. Click on the Python 3.x button under the Notebook section; this opens a new Python 3 notebook in a new JupyterLab tab;
2. a new IPython kernel will start in the background for the notebook.


#### Other Applications

* **OpenRefine:** [Button to launch OpenRefine] To allow the launch of OpenRefine, an `openrefine` module must be loaded. Depending on the software environment, load the most recent version of OpenRefine: for `StdEnv/2023`, no OpenRefine module is available as of August 2024; first load `StdEnv/2020`; for `StdEnv/2020`, load `openrefine/3.4.1`. An OpenRefine interface will be displayed or redisplayed in a new tab of your browser: it is possible to reopen an active OpenRefine session after the tab has been closed; the OpenRefine session ends at the same time as the JupyterLab session.
* **RStudio:** [Button to launch RStudio] To allow the launch of the RStudio application, load the `rstudio-server/4.3` module. An RStudio interface will be displayed or redisplayed in a new tab of your web browser: it is possible to reopen an active RStudio session after the web tab has been closed; the RStudio session ends at the same time as the JupyterLab session; exiting RStudio or closing the tabs for RStudio and JupyterHub will not end the use of resources (CPU, memory, GPU), nor the task that was submitted to the scheduler. Please close the session by selecting File--> Log Out under the JupyterLab tab.
* **VS Code:** [Button to launch VS Code] Before launching VS Code (Visual Studio Code), a `code-server` module must be loaded. Depending on the software environment, load the most recent version of VS Code: with `StdEnv/2023`, load `code-server/4.92.2`, with `StdEnv/2020`, load `code-server/3.12.0`. A VS Code interface will be displayed or redisplayed in a new tab of your browser: a new VS Code session can take up to 3 minutes to become functional; it is possible to reopen an active VS Code session after the tab has been closed; the VS Code session ends at the same time as the JupyterLab session.
* **Desktop:** [Button to launch Desktop] A Linux interface will be displayed or redisplayed in a new web tab of your browser: this is equivalent to starting a VNC server on a compute node, then creating an SSH tunnel and using a VNC client, but all this is not necessary with JupyterLab. It is possible to reopen an active Desktop session after the tab has been closed; the Desktop session ends at the same time as the JupyterLab session.


## Running Notebooks as Python Scripts

1. In the console or in a new cell, install `nbconvert`.
   ```bash
   !pip install --no-index nbconvert
   ```
2. Convert your notebooks to Python scripts.
   ```bash
   !jupyter nbconvert --to python my-current-notebook.ipynb
   ```
3. Create a non-interactive task and submit it. In the submission script, run the converted notebook with `python mynotebook.py` and submit your non-interactive task with
   ```bash
   [name@server ~] $ sbatch my-submit.sh
   ```


## Error Messages

Errors with JupyterHub are usually caused by the underlying task scheduler not responding or being unable to find the appropriate resources for your session, for example `Spawn failed: Timeout` `JupyterHub - Spawn failed: Timeout`

When launching a new session, JupyterHub automatically submits a new interactive task to the cluster. If the task does not start within the next five minutes, this message is displayed and the session is canceled.

As is the case for all interactive tasks on a cluster, requesting more execution time can result in a longer wait before the task can start, which can also occur when you request a GPU or too many CPU cores. Make sure you only request the resources you need.

If you have another interactive task on the same cluster, your Jupyter session will be queued with the other batch tasks. If possible, stop or cancel other interactive tasks before using JupyterHub.

It is possible that no resources are available at this time. Check if a problem is reported on the System Status page and try again later.


## References

<sup>[1]</sup> http://jupyterhub.readthedocs.io/en/latest/index.html


